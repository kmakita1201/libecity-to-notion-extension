# Mercari2Notion Chrome拡張機能 要求仕様書

## 1. プロジェクト概要

### 1.1 プロジェクト名
**Mercari2Notion - メルカリ売上管理・リピーター判定システム**

### 1.2 目的
メルカリの売上取引情報をNotionに自動転記し、購入者のリピート状況を判定して適切な購入御礼メッセージを自動生成するシステム

### 1.3 背景・課題
- メルカリでの売上管理が手動で非効率
- リピート購入者の判定が困難
- 購入者に応じた適切なメッセージ対応ができていない
- 取引履歴の一元管理が必要

## 2. 機能要件

### 2.1 主要機能

#### 2.1.1 売上情報自動取得・転記機能
**概要**: メルカリの売上一覧ページから取引情報を取得しNotionに保存

**詳細機能**:
- メルカリ売上一覧ページに「Notionへ保存」ボタンを動的に追加
- 各取引項目に対してボタンを設置
- クリック時に該当取引の詳細情報を取得
- Notion APIを通じてデータベースに自動保存

**取得対象情報**:
- 取引ID
- 商品名
- 販売価格
- 購入者情報（ユーザー名、プロフィールURL）
- 取引日時
- 取引ステータス
- 商品画像URL
- 商品詳細ページURL

#### 2.1.2 リピーター判定機能
**概要**: 購入者のプロフィールURLを基準にリピート購入履歴を判定

**判定ロジック**:
- 購入者のプロフィールURLをキーとして過去の取引履歴を検索
- 初回購入者: 過去の取引履歴なし
- リピーター: 過去に1回以上の取引履歴あり
- VIPリピーター: 過去に3回以上の取引履歴あり

#### 2.1.3 購入御礼メッセージ自動生成機能
**概要**: リピーター判定結果に基づいて適切なメッセージテンプレートを提供

**メッセージパターン**:
1. **初回購入者向け**
   ```
   この度はご購入いただき、ありがとうございます！
   初めてのお取引となりますが、何かご不明な点がございましたらお気軽にお声がけください。
   今後ともよろしくお願いいたします。
   ```

2. **リピーター向け**
   ```
   いつもありがとうございます！
   今回で○回目のお取引となります。
   継続してご愛顧いただき、心より感謝申し上げます。
   ```

3. **VIPリピーター向け**
   ```
   いつも大変お世話になっております！
   ○回目のお取引となり、特別なお客様として心より感謝しております。
   今後とも末永くよろしくお願いいたします。
   ```

### 2.2 補助機能

#### 2.2.1 設定管理機能
- Notion API キーの設定
- NotionデータベースIDの設定
- メッセージテンプレートのカスタマイズ
- 自動保存のON/OFF設定

#### 2.2.2 履歴管理機能
- 保存済み取引の履歴表示
- 重複保存の防止
- エラー履歴の記録

## 3. 技術仕様と制約事項

### 3.1 開発環境
- **プラットフォーム**: Chrome Extension (Manifest V3)
- **言語**: HTML, CSS, JavaScript
- **API**: Notion API v1
- **対象サイト**: https://jp.mercari.com/*

### 3.2 Chrome拡張機能の技術的制約

#### 3.2.1 実現可能な機能
✅ **DOM操作・UI追加**
- メルカリページへの「Notionへ保存」ボタン追加
- 取引情報の画面表示・抽出
- 保存状態の視覚的フィードバック

✅ **データ取得**
- Content Scriptによるページ内情報の抽出
- 取引ID、商品名、価格、購入者情報の取得
- ローカルストレージでの設定保存

✅ **外部API通信**
- Background ScriptからのNotion API呼び出し
- Content Script ↔ Background Script間のメッセージ通信

#### 3.2.2 技術的制約・不可能な機能
❌ **直接的なクロスオリジンリクエスト**
- Content ScriptからのNotion API直接呼び出し不可
- 必ずBackground Scriptを経由する必要あり

❌ **メルカリの内部API利用**
- メルカリの非公開API呼び出し不可
- 画面上に表示されている情報のみ取得可能

❌ **自動的な継続処理**
- ページ遷移を伴う自動操作不可
- ユーザーの明示的な操作が必要

❌ **メルカリサイトの構造変更への自動対応**
- HTML構造変更時は拡張機能の更新が必要

### 3.3 システム構成

#### 3.3.1 Chrome拡張機能構成
```
Mercari2Notion/
├── manifest.json              # 拡張機能設定
├── src/
│   ├── background/
│   │   └── background.js      # Notion API処理・メッセージ中継
│   ├── content/
│   │   ├── content.js         # DOM操作・情報抽出
│   │   └── content.css        # UI スタイル
│   ├── popup/
│   │   ├── popup.html         # ポップアップUI
│   │   ├── popup.css          # ポップアップスタイル
│   │   └── popup.js           # ポップアップ制御
│   ├── options/
│   │   ├── options.html       # 設定ページ
│   │   ├── options.css        # 設定ページスタイル
│   │   └── options.js         # 設定管理
│   └── utils/
│       ├── mercari-parser.js  # メルカリ情報解析
│       └── message-generator.js # メッセージ生成
└── assets/
    └── icons/                 # アイコン画像
```

#### 3.3.2 処理アーキテクチャ
```
[メルカリページ] 
    ↓ (Content Script)
[情報抽出・UI追加]
    ↓ (chrome.runtime.sendMessage)
[Background Script]
    ↓ (Notion API)
[Notionデータベース]
```

#### 3.3.3 Notionデータベース構造
**テーブル名**: メルカリ取引履歴

| 項目名 | タイプ | 説明 | 取得可能性 |
|--------|--------|------|------------|
| 取引ID | タイトル | メルカリの取引ID | ✅ 画面表示情報 |
| 商品名 | テキスト | 販売商品名 | ✅ 画面表示情報 |
| 販売価格 | 数値 | 販売金額 | ✅ 画面表示情報 |
| 購入者名 | テキスト | 購入者のユーザー名 | ✅ 画面表示情報 |
| 購入者URL | URL | 購入者プロフィールURL | ✅ リンク抽出可能 |
| 取引日時 | 日付 | 取引成立日時 | ✅ 画面表示情報 |
| 取引ステータス | セレクト | 取引の進行状況 | ✅ 画面表示情報 |
| 商品画像 | ファイル | 商品画像 | ⚠️ URLのみ取得可能 |
| 商品URL | URL | 商品詳細ページURL | ✅ リンク抽出可能 |
| リピート回数 | 数値 | 該当購入者の取引回数 | ✅ Notion検索で算出 |
| 顧客ランク | セレクト | 初回/リピーター/VIP | ✅ 算出ロジックで判定 |
| 推奨メッセージ | テキスト | 自動生成されたメッセージ | ✅ テンプレート生成 |
| 保存日時 | 日付 | Notionへの保存日時 | ✅ 拡張機能で付与 |

### 3.4 処理フロー

#### 3.4.1 基本処理フロー（実装可能範囲）
1. **ページ読み込み時（Content Script）**
   - メルカリ売上一覧ページのURL検出
   - DOMの解析と取引項目の特定
   - 各取引項目に「Notionへ保存」ボタンを動的追加
   - 既存保存データとの照合で重複防止

2. **保存ボタンクリック時（Content Script → Background Script）**
   - 該当取引の詳細情報をDOM から抽出
   - Background Scriptにメッセージ送信
   - Background ScriptでNotion API呼び出し
   - 購入者URLを基準に過去の取引履歴を検索
   - リピート回数を算出し顧客ランクを判定
   - 適切なメッセージテンプレートを生成
   - Notionデータベースに保存
   - Content Scriptに結果を返却
   - UIで保存状態を表示

#### 3.4.2 技術的制約に基づく修正処理
```javascript
// Content Script（メルカリページ上）
function extractTransactionData(element) {
    return {
        transactionId: element.querySelector('[data-testid="transaction-id"]')?.textContent,
        productName: element.querySelector('.product-name')?.textContent,
        price: element.querySelector('.price')?.textContent,
        buyerName: element.querySelector('.buyer-name')?.textContent,
        buyerUrl: element.querySelector('.buyer-link')?.href,
        // 画面上の表示情報のみ取得可能
    };
}

// Background Script（Notion API処理）
async function checkRepeatCustomer(customerUrl) {
    // Content ScriptからのCORS制約回避
    const pastTransactions = await notionClient.databases.query({
        database_id: DATABASE_ID,
        filter: {
            property: '購入者URL',
            url: { equals: customerUrl }
        }
    });
    
    const repeatCount = pastTransactions.results.length;
    let customerRank = '初回';
    
    if (repeatCount >= 3) {
        customerRank = 'VIP';
    } else if (repeatCount >= 1) {
        customerRank = 'リピーター';
    }
    
    return {
        repeatCount: repeatCount + 1,
        customerRank: customerRank
    };
}
```

## 4. UI/UX仕様（技術制約考慮版）

### 4.1 メルカリページ上のUI（Content Script実装）
- **保存ボタン**: 各取引項目の右側に青色の「Notionへ保存」ボタンを動的挿入
- **保存状態表示**: 保存済みの場合はボタンを「保存済み」に変更し、グレーアウト
- **処理中表示**: 保存処理中はローディングアニメーションを表示
- **エラー表示**: API エラー時は赤色で「エラー」表示
- **制約**: メルカリのCSS変更に影響される可能性あり

### 4.2 拡張機能ポップアップ
- **ステータス表示**: 現在のページが対応ページかどうかを表示
- **設定リンク**: オプションページへのリンク
- **履歴表示**: 最近の保存履歴（最大5件）
- **接続状態**: Notion API接続状態の表示

### 4.3 設定ページ（Options Page）
- **Notion設定**: APIキー、データベースID入力フォーム
- **接続テスト**: 設定値の検証機能
- **メッセージ設定**: 各顧客ランク別のメッセージテンプレート編集
- **動作設定**: 自動保存のON/OFF、重複チェックの設定
- **制約表示**: Chrome拡張機能の制約事項の説明

## 5. セキュリティ・プライバシー

### 5.1 データ保護
- Notion APIキーはChrome拡張機能のstorageに暗号化して保存
- 個人情報は最小限の取得に留める
- データの外部送信はNotion APIのみに限定

### 5.2 権限管理
- 必要最小限の権限のみを要求
- メルカリドメインのみにアクセス制限
- ユーザーの明示的な操作でのみデータ送信

## 6. 運用・保守・制限事項

### 6.1 Chrome拡張機能特有の制限事項

#### 6.1.1 技術的制限
- **対応ブラウザ**: Chrome、Edge、Brave等のChromium系ブラウザのみ
- **対応ページ**: メルカリの売上一覧ページのみ（URL: `https://jp.mercari.com/sell/completed/*`）
- **情報取得範囲**: 画面上に表示されている情報のみ取得可能
- **API制限**: Notion APIのレート制限（3リクエスト/秒）に準拠
- **セキュリティ制約**: Content SecurityPolicy（CSP）の制限

#### 6.1.2 機能的制限
- **自動処理不可**: ページ遷移や継続的な監視は不可
- **メルカリAPI利用不可**: 公式APIが存在しないため画面スクレイピングのみ
- **リアルタイム同期不可**: 手動での「保存」ボタンクリックが必要
- **データ整合性**: メルカリのHTML構造変更時は動作不可

### 6.2 エラーハンドリング
- Notion API エラー時の適切なエラーメッセージ表示
- ネットワークエラー時の再試行機能
- 設定不備時の分かりやすいガイダンス
- メルカリHTML構造変更時の検出とエラー表示

### 6.3 更新・メンテナンス計画
- **緊急対応**: メルカリのHTML構造変更時の緊急修正（24時間以内）
- **定期更新**: 月1回の動作確認とUI改善
- **バージョン管理**: セマンティックバージョニング（例: v1.2.3）
- **ユーザーサポート**: GitHub Issues、FAQ、使用方法ドキュメント

### 6.4 リスク管理
- **メルカリ利用規約**: スクレイピングに関する規約変更リスク
- **HTML構造変更**: セレクタ指定の破綻リスク
- **Notion API変更**: API仕様変更への対応リスク
- **Chrome拡張機能ポリシー**: Manifest V3の今後の変更リスク

## 7. 今後の拡張予定（技術制約内）

### 7.1 実現可能な機能拡張
- 売上統計・分析機能（Notionデータベース内での集計）
- 顧客管理機能の強化（リピーター分析の詳細化）
- メッセージテンプレートの充実化
- 保存履歴の管理機能

### 7.2 技術制約により困難な機能
- ❌ 他のフリマアプリ対応（個別の拡張機能が必要）
- ❌ メッセージの自動送信機能（メルカリAPI未提供）
- ❌ リアルタイム売上監視（継続処理不可）
- ❌ 完全自動化（ユーザー操作必須）

### 7.3 改善項目
- UI/UXの継続改善
- 処理速度の最適化
- エラーハンドリングの強化
- メルカリHTML構造変更への対応力強化

---

**作成日**: 2024年12月
**バージョン**: 1.0.0
**作成者**: Mercari2Notion開発チーム 